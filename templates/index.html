<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Server Management Console</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .card { margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">DNS Server Management Console</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        <pre>{{ message }}</pre>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <!-- Stats & Tools Column -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Statistics</div>
                    <div class="card-body">
                        <h5 class="card-title">Total Cached Domains</h5>
                        <!-- ID اضافه شد برای به‌روزرسانی با جاوا اسکریپت -->
                        <p class="card-text fs-2" id="total-cached-count">{{ total_cached }}</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">DNS Lookup Tool</div>
                    <div class="card-body">
                        <form action="/lookup" method="post">
                            <div class="mb-3">
                                <label for="domain" class="form-label">Domain Name</label>
                                <input type="text" class="form-control" id="domain" name="domain" required>
                            </div>
                            <div class="mb-3">
                                <label for="qtype" class="form-label">Query Type</label>
                                <select class="form-select" id="qtype" name="qtype">
                                    <option>A</option>
                                    <option>AAAA</option>
                                    <option>MX</option>
                                    <option>CNAME</option>
                                    <option>TXT</option>
                                    <option>NS</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Lookup</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Manage Forwarders</div>
                    <div class="card-body">
                        <h6>Current Forwarders:</h6>
                        <ul class="list-group mb-3">
                            {% for f in forwarders %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ f }}
                                <form action="/forwarders/delete" method="post" class="d-inline">
                                    <input type="hidden" name="forwarder_ip" value="{{ f }}">
                                    <button type="submit" class="btn btn-sm btn-danger">&times;</button>
                                </form>
                            </li>
                            {% endfor %}
                        </ul>
                        <form action="/forwarders/add" method="post">
                            <div class="input-group">
                                <input type="text" class="form-control" name="forwarder_ip" placeholder="Add new forwarder IP" required>
                                <button class="btn btn-success" type="submit">Add</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Cache Table Column -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">Cached Records</div>
                    <div class="card-body" style="max-height: 80vh; overflow-y: auto;">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>Type</th>
                                    <th>Request Count</th>
                                    <th>Expires (UTC)</th>
                                </tr>
                            </thead>
                            <!-- ID اضافه شد برای به‌روزرسانی با جاوا اسکریپت -->
                            <tbody id="cache-table-body">
                                {% for item in cached_items %}
                                <tr>
                                    <td>{{ item['domain'] }}</td>
                                    <td>{{ item['qtype_name'] }}</td>
                                    <td>{{ item['request_count'] }}</td>
                                    <td>{{ item['expiry_timestamp']|strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    
    <!-- بخش جدید: اسکریپت به‌روزرسانی زنده -->
    <script>
        function updateStats() {
            // *** FIX: Use full URL to avoid issues in sandboxed environments ***
            const statsUrl = new URL('/api/stats', window.location.origin);
            fetch(statsUrl)
                .then(response => response.json())
                .then(data => {
                    // به‌روزرسانی تعداد کل
                    document.getElementById('total-cached-count').innerText = data.total_cached;

                    // به‌روزرسانی جدول رکوردها
                    const tableBody = document.getElementById('cache-table-body');
                    let newRows = '';
                    
                    data.cached_items.forEach(item => {
                        // Convert timestamp to formatted date string
                        const expiryDate = new Date(item.expiry_timestamp * 1000);
                        const formattedDate = expiryDate.toISOString().slice(0, 19).replace('T', ' ');

                        newRows += `
                            <tr>
                                <td>${item.domain}</td>
                                <td>${item.qtype_name}</td>
                                <td>${item.request_count}</td>
                                <td>${formattedDate}</td>
                            </tr>
                        `;
                    });
                    tableBody.innerHTML = newRows;
                })
                .catch(error => console.error('Error fetching stats:', error));
        }

        // اجرای تابع به‌روزرسانی هر 5 ثانیه
        setInterval(updateStats, 5000);
    </script>
    <!-- پایان بخش جدید -->
</body>
</html>


